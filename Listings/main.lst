C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\WorkSoftware\Keil5_C51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\code) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2          program versions : 2.4.1
   3          
   4          æ­¤åˆ†æ”¯[branch2]ç”¨äºç¼–å†™æ ¡éªŒçš„ä»£ç 
   5          æ­¤ç‰ˆæœ¬å·²èƒ½æ­£å¸¸æµ‹è¯•ç”µå®¹ï¼Œé¢˜ç›®ç»™å‡ºçš„ç”µå®¹éƒ½å·²ç»èƒ½æ£€æµ‹äº†.
   6          
   7          modification: 2023/11/20 14:02
   8          
   9          modifier: Cameron Bright
  10          
  11          */
  12          
  13          #include "main.h"
  14          #include <string.h>
  15          #include "LCD1602.h"  //åŒ…å«LCD1602å¤´æ–‡ä»¶
  16          #include "Key.h"      //æŒ‰é”®æ‰«æå‡½æ•°
  17          #include "ADC.h"
  18          #include "Relay.h"    //ç»§ç”µå™¨å¤´æ–‡ä»¶
  19          #include <stdio.h>
  20          
  21          sbit Buzzer = P2^3;//èœ‚é¸£å™¨ ä½ç”µå¹³å·¥ä½œ
  22          
  23          void Timer0_Init(void); //1æ¯«ç§’@11.0592MHz
  24          void Delay(unsigned int delay); //å®šæ—¶å™¨å»¶æ—¶ 
  25          
  26          void Key_Proc(void);       //Keystroke process function
  27          void Lcd_Proc(void);       //LCD Dsiplay process function
  28          void Detection_Proc(void); //cap detection process function
  29          
  30          unsigned int key_slow_down = 0; //æŒ‰é”®åˆ·æ–°è®¡æ•°
  31          unsigned int lcd_slow_down = 0; //LCDåˆ·æ–°è®¡æ•°
  32          unsigned int Det_slow_down = 0; //adcæ£€æµ‹åˆ·æ–°è®¡æ•°
  33          
  34          unsigned int timer_tick = 0;
  35          unsigned int buzzer_tick = 0;//ç”¨äºå¼€æœºè®¡æ•°500ms
  36          
  37          unsigned char key_value; //æŒ‰é”®å¤„ç†å˜é‡
  38          unsigned char key_down;  //æŒ‰é”®ä¸‹é™æ²¿
  39          unsigned char key_up;    //ä¸Šå‡æ²¿
  40          unsigned char key_old;   //ä¸Šæ¬¡çš„æŒ‰é”®å€¼
  41          
  42          unsigned int led1_tick = 1; //çŠ¶æ€ç¯è®¡æ•°
  43          unsigned int key_tick; //long key press count
  44          unsigned int delay_tick;//å®šæ—¶å™¨å»¶æ—¶è®¡æ•°
  45          unsigned int cap_tick;  //ç”µå®¹æµ‹é‡è®¡è®¡æ—¶
  46          unsigned int relay_tick = 0;//ç»§ç”µå™¨è®¡æ—¶
  47          
  48          unsigned char dispbuf[6] = {'0','0','0','0','0','0'};
  49          unsigned char page = 0;//lcd æ˜¾ç¤ºç•Œé¢
  50          unsigned char cursor = 5; //å…‰æ ‡
  51          
  52          unsigned char relay_index;  //ç»§ç”µå™¨é€‰æ‹©
  53          
  54          unsigned char password[6] = {'0','0','0','0','0','0'};
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 2   

  55          //unsigned char password_true[6] = {'8','7','6','5','4','3'};
  56          
  57          unsigned char password_true[6] = {'1','0','0','0','0','0'}; //æ­£ç¡®å¯†ç 
  58          //unsigned char password_true[6] = {'8','7','6','5','4','3'}; //æ­£ç¡®å¯†ç 
  59          unsigned char password_for = 0; //index
  60          
  61          unsigned char adc_char;     //adcæ£€æµ‹è¿”å›çš„charç±»å‹å€¼
  62          float adc_float;            //adcæ£€æµ‹è¿”å›çš„floatç±»å‹å€¼ï¼Œå°±æ˜¯å…·ä½“çš„ç”µå‹å€¼
  63          
  64          xdata float cap_value_k1;         
  65          xdata float cap_value_k2;
  66          xdata float cap_value_k3;
  67          xdata float cap_value_k4;
  68          
  69          float cap_value;            //å­˜æ”¾ç”µå®¹çš„å®¹å€¼
  70          char cap_units;             //ç”µå®¹çš„å•ä½0:uFã€1:nFã€ 2:pF
  71          
  72          void main()
  73          {
  74   1        Timer0_Init();//å®šæ—¶å™¨åˆå§‹åŒ–
  75   1        LCD_Init(); //LCDå‡½æ•°åˆå§‹åŒ–
  76   1        ADC_Init(); //ADCå‡½æ•°åˆå§‹åŒ–
  77   1        
  78   1        //Buzzer = 0;//èœ‚é¸£å™¨åˆå§‹åŒ–
  79   1        
  80   1        Relay_Control(0, 0);//ç»§ç”µå™¨å…¨å…³
  81   1        
  82   1        while(1)
  83   1        { 
  84   2          Key_Proc();
  85   2          Lcd_Proc();
  86   2          Detection_Proc(); 
  87   2        }
  88   1      }
  89          
  90          //================LCD=======================
  91          
  92          void Lcd_Proc(void)     //LCD Dsiplay process function
  93          {
  94   1        if(lcd_slow_down) return;   //200msåˆ·æ–°ä¸€æ¬¡
  95   1          lcd_slow_down = 1;
  96   1        
  97   1        if(page == 0)            //æµ‹é‡ç•Œé¢ åˆå§‹ç•Œé¢
  98   1        { 
  99   2          sprintf((char *)dispbuf,"%06.2f",cap_value);
 100   2          
 101   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 102   2          
 103   2          LCD_ShowString(1,1,"Press OK Start!");
 104   2          
 105   2          LCD_ShowChar(2,1,dispbuf[0]);
 106   2          LCD_ShowChar(2,2,dispbuf[1]);
 107   2          LCD_ShowChar(2,3,dispbuf[2]);
 108   2          LCD_ShowChar(2,4,dispbuf[3]);
 109   2          LCD_ShowChar(2,5,dispbuf[4]);
 110   2          LCD_ShowChar(2,6,dispbuf[5]);
 111   2          
 112   2          switch(cap_units)
 113   2          {
 114   3            case 0:
 115   3              LCD_ShowString(2,7,"uF");
 116   3              break;
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 3   

 117   3            case 1:
 118   3              LCD_ShowString(2,7,"nF");
 119   3              break;
 120   3            case 2:
 121   3              LCD_ShowString(2,7,"pF");
 122   3              break;
 123   3            default:
 124   3              break;
 125   3          }
 126   2          
 127   2          //LCD_ShowNum(2,8,key_tick,4); //æµ‹è¯•æŒ‰é”®é•¿æŒ‰
 128   2        }
 129   1        else if(page == 1)       //è¾“å¯†ç é¡µ
 130   1        {
 131   2          LCD_WriteCommand(0x0f);//å¼€å…‰æ ‡
 132   2          
 133   2          LCD_ShowString(1,2,"Input Password");
 134   2          LCD_ShowString(2,6,password);
 135   2        }
 136   1        else if(page == 2)       //å¯†ç é”™è¯¯é¡µ
 137   1        {
 138   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 139   2          LCD_ShowString(1,6,"ERROR");
 140   2        }
 141   1        else if(page == 3)       //å¯†ç æ­£ç¡®é¡µ
 142   1        {
 143   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 144   2          LCD_ShowString(1,6,"RIGHT");
 145   2        }
 146   1        else if(page == 4)
 147   1        {
 148   2          LCD_ShowString(1,1,"Wait...");
 149   2          LCD_ShowString(2,1,"Press OK End");
 150   2        }
 151   1        
 152   1        if(page == 2 || page == 3) //é—ªä¸€ä¸‹ERRORå’ŒRIGHTçš„é¡µé¢
 153   1        {
 154   2          Delay(2000); //ä¸¤ç§’ååˆ‡æ¢é¡µé¢
 155   2          Lcd_Clear();
 156   2          page = 0;//å¯†ç è¾“å®Œååˆ‡æ¢åˆ°æ ¡å‡†é¡µé¢   
 157   2        }
 158   1        
 159   1        //LCD_WriteCommand(0x80+cursor); //ç¬¬ä¸€è¡Œå…‰æ ‡
 160   1        LCD_WriteCommand(0xc0+cursor); //ç¬¬äºŒè¡Œå…‰æ ‡ 
 161   1      }
 162          
 163          //================Key=======================
 164          
 165          void Key_Proc(void)
 166          {
 167   1        if(key_slow_down) return;   //10msæ›´æ–°ä¸€æ¬¡
 168   1          key_slow_down = 1;
 169   1        
 170   1        key_value = Key_Read();
 171   1        key_down = key_value & (key_value ^ key_old);
 172   1        key_up = ~key_value & (key_value ^ key_old);
 173   1        key_old = key_value;
 174   1      
 175   1        if(key_down)       //é•¿æŒ‰äº”ç§’
 176   1          key_tick = 2000;
 177   1        
 178   1        if(key_old)
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 4   

 179   1        {
 180   2          if(key_tick == 0)
 181   2            {
 182   3              Lcd_Clear();
 183   3              page = 1;
 184   3              
 185   3              //æ¸…ç©ºå¯†ç å­—ç¬¦ä¸²
 186   3              for(password_for = 0;password_for <= 5; password_for++)
 187   3              {
 188   4                password[password_for] = '0';
 189   4              }
 190   3            }
 191   2        }
 192   1        
 193   1        if(key_tick)
 194   1        {
 195   2          switch(key_up)
 196   2          {
 197   3            case 1:        //èƒŒå…‰/æ ¡å‡†æŒ‰é”®
 198   3            {
 199   4              key_tick = 0;
 200   4              break;
 201   4            }
 202   3            case 2:        //â†‘ 
 203   3            {
 204   4              password[cursor-5] += 1;
 205   4              if(password[cursor-5] > '9')
 206   4                password[cursor-5] = '9';
 207   4            
 208   4              key_tick = 0;
 209   4              break;
 210   4            }
 211   3            case 3:        //â†“
 212   3            {
 213   4              password[cursor-5] -= 1;
 214   4              if(password[cursor-5] == '/')
 215   4                password[cursor-5] = '0';
 216   4              
 217   4              key_tick = 0;
 218   4              break;
 219   4            }
 220   3            case 4:        //â†
 221   3            {
 222   4              if(--cursor <= 5)
 223   4                cursor = 5;
 224   4              key_tick = 0;
 225   4              break;
 226   4            }
 227   3            case 5:        //â†’
 228   3            {
 229   4              if(++cursor >= 10)
 230   4                cursor = 10;
 231   4              key_tick = 0;
 232   4              break;
 233   4            }
 234   3            case 6:        //OK
 235   3            {
 236   4              if(page == 0)      //å¦‚æœåœ¨æµ‹é‡é¡µï¼ŒæŒ‰ä¸‹OKé”®å¼€å§‹æµ‹é‡
 237   4              {
 238   5                Lcd_Clear();
 239   5                page = 4;
 240   5                //K1 = 0;
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 5   

 241   5              }
 242   4              else if(page == 4) //å¦‚æœæ­£åœ¨æµ‹é‡ï¼ŒæŒ‰ä¸‹OKé”®åœæ­¢æµ‹é‡
 243   4              {
 244   5                Lcd_Clear();
 245   5                page = 0;
 246   5                
 247   5              if(cap_value_k1 < 2.20 && cap_value_k1 > 0.50)
 248   5              {
 249   6                cap_value = cap_value_k1;
 250   6                cap_units = 0;           //å•ä½æ¢æˆuF
 251   6              }
 252   5              else if(cap_value_k1 <= 0.50 && cap_value_k2 > 0.50)
 253   5              {
 254   6                cap_value = cap_value_k2 * 100;
 255   6                cap_units = 1;           //å•ä½æ¢æˆnF
 256   6              }
 257   5              else if(cap_value_k2 <= 0.50 && cap_value_k3 > 0.50)
 258   5              {
 259   6                cap_value = cap_value_k3 * 10;
 260   6                cap_units = 1;           //å•ä½æ¢æˆnF
 261   6              }
 262   5              else if(cap_value_k3 <= 0.50 && cap_value_k4 > 0.00)
 263   5              {
 264   6                cap_value = cap_value_k4;
 265   6                cap_units = 1;
 266   6              }
 267   5              
 268   5              cap_value_k1 = cap_value_k2 = cap_value_k3 = cap_value_k4 = 0;
 269   5      //        else if(cap_value_k3 <= 0.10 && cap_value_k4 > 0.00)
 270   5      //        {
 271   5      //          cap_value = cap_value_k3 * 10;
 272   5      //          cap_units = 1;
 273   5      //        }
 274   5      //          if((char)cap_value_k1 != 0)//çœ‹ä¸€ä¸‹ä¸ªä½æ•°æœ‰æ²¡æœ‰å€¼
 275   5      //          {
 276   5      //            cap_value = cap_value_k1;
 277   5      //            cap_units = 0;           //å•ä½æ¢æˆuF
 278   5      //          }else if((char)cap_value_k1 == 0 && (char)cap_value_k2 != 0) //k1æµ‹ä¸åˆ°å°±æ¢k2çš„å€¼
 279   5      //          {
 280   5      //            cap_value = cap_value_k2;
 281   5      //            cap_units = 1;           //å•ä½æ¢æˆnF
 282   5      //          }else if((char)cap_value_k1 == 0 && (char)cap_value_k2 == 0 && (char)cap_value_k3 != 0) //k1æµ‹ä¸å
             -ˆ°å°±æ¢k3çš„å€¼
 283   5      //          {
 284   5      //            cap_value = cap_value_k3;
 285   5      //            cap_units = 2;           //å•ä½æ¢æˆpF
 286   5      //          }
 287   5                
 288   5                
 289   5              }
 290   4              else if(page == 1) //å¦‚æœåœ¨è¾“å¯†ç é¡µï¼ŒæŒ‰ä¸‹OKé”®ç¡®è®¤å¯†ç 
 291   4              {
 292   5                Lcd_Clear();
 293   5                if(strncmp(password,password_true,6) == 0)
 294   5                  page = 3;
 295   5                else
 296   5                  page = 2;
 297   5              }
 298   4              
 299   4              key_tick = 0;
 300   4              break;
 301   4            }
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 6   

 302   3            
 303   3            default:
 304   3              break;
 305   3          }   
 306   2        }
 307   1      }
 308          
 309          //================ç”µå®¹æ£€æµ‹å‡½æ•°======================
 310          void Detection_Proc(void)
 311          {
 312   1        if(Det_slow_down) return;   //10msæ›´æ–°ä¸€æ¬¡
 313   1        Det_slow_down = 1;
 314   1        
 315   1        if(relay_index == 1)
 316   1        {
 317   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 318   2          cap_value_k1 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 319   2        }
 320   1        else if(relay_index == 2)
 321   1        {
 322   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 323   2          cap_value_k2 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 324   2        }
 325   1        else if(relay_index == 3)
 326   1        {
 327   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 328   2          cap_value_k3 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 329   2        }
 330   1        else if(relay_index == 4)
 331   1        {
 332   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 333   2          cap_value_k4 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 334   2        }
 335   1        
 336   1      //  if(page == 4)
 337   1      //  {
 338   1      //    
 339   1      //    
 340   1      //    if((char)adc_float > 0)
 341   1      //    {
 342   1      //      cap_value = adc_float;
 343   1      //      cap_units = 0;  //unitsï¼šuF
 344   1      //    }
 345   1      //      
 346   1      //  }
 347   1      }
 348          
 349          //================ä¸­æ–­å‡½æ•°=======================
 350          void Timer0_Isr(void) interrupt 1
 351          {
 352   1        if(++key_slow_down == 10) key_slow_down = 0;
 353   1        if(++lcd_slow_down == 200) lcd_slow_down = 0;
 354   1        if(++Det_slow_down == 10) Det_slow_down = 0;
 355   1        
 356   1        if(delay_tick > 0) delay_tick--;//å»¶æ—¶å‡½æ•° ä¼šå¡ä½å½“å‰å‡½æ•°
 357   1        if(key_tick > 0) key_tick--;    //æŒ‰é”®è®¡æ—¶
 358   1        
 359   1        //å‘¼å¸ç¯ ç”¨äºæµ‹è¯•ä¸­æ–­
 360   1      //  if(++led1_tick >= 1000)
 361   1      //  {
 362   1      //    LED1 ^= 1;
 363   1      //    led1_tick = 0;
C51 COMPILER V9.60.0.0   MAIN                                                              12/12/2023 17:32:04 PAGE 7   

 364   1      //  }
 365   1          
 366   1        
 367   1      //  if(Buzzer == 0)
 368   1      //  {
 369   1      //    if(++buzzer_tick >= 500)
 370   1      //      {
 371   1      //        Buzzer = 1;
 372   1      //        buzzer_tick = 0;
 373   1      //      }
 374   1      //  }   
 375   1      
 376   1      //---------ç»§ç”µå™¨åˆ‡æ¢æ§åˆ¶----------------------
 377   1        if(page ==  4)
 378   1        {
 379   2          if(++relay_tick > 1000)
 380   2          {
 381   3            if(++relay_index > 4)
 382   3              relay_index = 1;
 383   3            relay_tick = 0;
 384   3          }
 385   2          
 386   2          Relay_Control(relay_index, 1);
 387   2        }   
 388   1          
 389   1        
 390   1      }
 391          
 392          void Delay(unsigned int delay) //å®šæ—¶å™¨å»¶æ—¶ ä¼šå¡ä½å½“å‰å‡½æ•°
 393          {
 394   1        delay_tick = delay;
 395   1        while(delay_tick > 0);
 396   1      }
 397          
 398          void Timer0_Init(void)    //1æ¯«ç§’@11.0592MHz
 399          {
 400   1        AUXR |= 0x80;     //å®šæ—¶å™¨æ—¶é’Ÿ1Tæ¨¡å¼
 401   1        TMOD &= 0xF0;     //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 402   1        TL0 = 0xCD;       //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 403   1        TH0 = 0xD4;       //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 404   1        TF0 = 0;        //æ¸…é™¤TF0æ ‡å¿—
 405   1        TR0 = 1;        //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 406   1        ET0 = 1;        //ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
 407   1        EA = 1;         //æ€»ä¸­æ–­
 408   1      }
 409           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1352    ----
   CONSTANT SIZE    =     80    ----
   XDATA SIZE       =     16    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     56    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
