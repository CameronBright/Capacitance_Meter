C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\WorkSoftware\Keil5_C51\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\code) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2          program versions : 2.3.1
   3          
   4          æ­¤ç‰ˆæœ¬å¯ä»¥è‡ªåŠ¨åˆ‡æ¢ç»§ç”µå™¨ï¼Œä½†æ— æ³•åˆ¤æ–­ç”µå®¹çš„å•ä½ï¼Œå¹¶ä¸”åªèƒ½æ£€æµ‹22uF
   5          
   6          modification: 2023/11/19 17:44
   7          
   8          modifier: Cameron Bright
   9          
  10          */
  11          
  12          #include "main.h"
  13          #include <string.h>
  14          #include "LCD1602.h"  //åŒ…å«LCD1602å¤´æ–‡ä»¶
  15          #include "Key.h"      //æŒ‰é”®æ‰«æå‡½æ•°
  16          #include "ADC.h"
  17          #include "Relay.h"    //ç»§ç”µå™¨å¤´æ–‡ä»¶
  18          #include <stdio.h>
  19          
  20          sbit Buzzer = P2^3;//èœ‚é¸£å™¨ ä½ç”µå¹³å·¥ä½œ
  21          
  22          void Timer0_Init(void); //1æ¯«ç§’@11.0592MHz
  23          void Delay(unsigned int delay); //å®šæ—¶å™¨å»¶æ—¶ 
  24          
  25          void Key_Proc(void);       //Keystroke process function
  26          void Lcd_Proc(void);       //LCD Dsiplay process function
  27          void Detection_Proc(void); //cap detection process function
  28          
  29          unsigned int key_slow_down = 0; //æŒ‰é”®åˆ·æ–°è®¡æ•°
  30          unsigned int lcd_slow_down = 0; //LCDåˆ·æ–°è®¡æ•°
  31          unsigned int Det_slow_down = 0; //adcæ£€æµ‹åˆ·æ–°è®¡æ•°
  32          
  33          unsigned int timer_tick = 0;
  34          unsigned int buzzer_tick = 0;//ç”¨äºå¼€æœºè®¡æ•°500ms
  35          
  36          unsigned char key_value; //æŒ‰é”®å¤„ç†å˜é‡
  37          unsigned char key_down;  //æŒ‰é”®ä¸‹é™æ²¿
  38          unsigned char key_up;    //ä¸Šå‡æ²¿
  39          unsigned char key_old;   //ä¸Šæ¬¡çš„æŒ‰é”®å€¼
  40          
  41          unsigned int led1_tick = 1; //çŠ¶æ€ç¯è®¡æ•°
  42          unsigned int key_tick; //long key press count
  43          unsigned int delay_tick;//å®šæ—¶å™¨å»¶æ—¶è®¡æ•°
  44          unsigned int cap_tick;  //ç”µå®¹æµ‹é‡è®¡è®¡æ—¶
  45          unsigned int relay_tick = 0;//ç»§ç”µå™¨è®¡æ—¶
  46          
  47          unsigned char dispbuf[6] = {'0','0','0','0','0','0'};
  48          unsigned char page = 0;//lcd æ˜¾ç¤ºç•Œé¢
  49          unsigned char cursor = 5; //å…‰æ ‡
  50          
  51          unsigned char relay_index;  //ç»§ç”µå™¨é€‰æ‹©
  52          
  53          unsigned char password[6] = {'0','0','0','0','0','0'};
  54          //unsigned char password_true[6] = {'8','7','6','5','4','3'};
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 2   

  55          
  56          unsigned char password_true[6] = {'1','0','0','0','0','0'}; //æ­£ç¡®å¯†ç 
  57          //unsigned char password_true[6] = {'8','7','6','5','4','3'}; //æ­£ç¡®å¯†ç 
  58          unsigned char password_for = 0; //index
  59          
  60          unsigned char adc_char;     //adcæ£€æµ‹è¿”å›çš„charç±»å‹å€¼
  61          float adc_float;            //adcæ£€æµ‹è¿”å›çš„floatç±»å‹å€¼ï¼Œå°±æ˜¯å…·ä½“çš„ç”µå‹å€¼
  62          
  63          xdata float cap_value_k1;         
  64          xdata float cap_value_k2;
  65          xdata float cap_value_k3;
  66          xdata float cap_value_k4;
  67          
  68          float cap_value;            //å­˜æ”¾ç”µå®¹çš„å®¹å€¼
  69          char cap_units;             //ç”µå®¹çš„å•ä½0:uFã€1:nFã€ 2:pF
  70          
  71          void main()
  72          {
  73   1        Timer0_Init();//å®šæ—¶å™¨åˆå§‹åŒ–
  74   1        LCD_Init(); //LCDå‡½æ•°åˆå§‹åŒ–
  75   1        ADC_Init(); //ADCå‡½æ•°åˆå§‹åŒ–
  76   1        
  77   1        //Buzzer = 0;//èœ‚é¸£å™¨åˆå§‹åŒ–
  78   1        
  79   1        Relay_Control(0, 0);//ç»§ç”µå™¨å…¨å…³
  80   1        
  81   1        while(1)
  82   1        { 
  83   2          Key_Proc();
  84   2          Lcd_Proc();
  85   2          Detection_Proc(); 
  86   2        }
  87   1      }
  88          
  89          //================LCD=======================
  90          
  91          void Lcd_Proc(void)     //LCD Dsiplay process function
  92          {
  93   1        if(lcd_slow_down) return;   //200msåˆ·æ–°ä¸€æ¬¡
  94   1          lcd_slow_down = 1;
  95   1        
  96   1        if(page == 0)            //æµ‹é‡ç•Œé¢ åˆå§‹ç•Œé¢
  97   1        { 
  98   2          sprintf((char *)dispbuf,"%06.2f",cap_value);
  99   2          
 100   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 101   2          
 102   2          LCD_ShowString(1,1,"Press OK Start!");
 103   2          
 104   2          LCD_ShowChar(2,1,dispbuf[0]);
 105   2          LCD_ShowChar(2,2,dispbuf[1]);
 106   2          LCD_ShowChar(2,3,dispbuf[2]);
 107   2          LCD_ShowChar(2,4,dispbuf[3]);
 108   2          LCD_ShowChar(2,5,dispbuf[4]);
 109   2          LCD_ShowChar(2,6,dispbuf[5]);
 110   2          
 111   2          switch(cap_units)
 112   2          {
 113   3            case 0:
 114   3              LCD_ShowString(2,7,"uF");
 115   3              break;
 116   3            case 1:
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 3   

 117   3              LCD_ShowString(2,7,"nF");
 118   3              break;
 119   3            case 2:
 120   3              LCD_ShowString(2,7,"pF");
 121   3              break;
 122   3            default:
 123   3              break;
 124   3          }
 125   2          
 126   2          //LCD_ShowNum(2,8,key_tick,4); //æµ‹è¯•æŒ‰é”®é•¿æŒ‰
 127   2        }
 128   1        else if(page == 1)       //è¾“å¯†ç é¡µ
 129   1        {
 130   2          LCD_WriteCommand(0x0f);//å¼€å…‰æ ‡
 131   2          
 132   2          LCD_ShowString(1,2,"Input Password");
 133   2          LCD_ShowString(2,6,password);
 134   2        }
 135   1        else if(page == 2)       //å¯†ç é”™è¯¯é¡µ
 136   1        {
 137   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 138   2          LCD_ShowString(1,6,"ERROR");
 139   2        }
 140   1        else if(page == 3)       //å¯†ç æ­£ç¡®é¡µ
 141   1        {
 142   2          LCD_WriteCommand(0x0C);//å…³å…‰æ ‡
 143   2          LCD_ShowString(1,6,"RIGHT");
 144   2        }
 145   1        else if(page == 4)
 146   1        {
 147   2          LCD_ShowString(1,1,"Wait...");
 148   2          LCD_ShowString(2,1,"Press OK End");
 149   2        }
 150   1        
 151   1        if(page == 2 || page == 3) //é—ªä¸€ä¸‹ERRORå’ŒRIGHTçš„é¡µé¢
 152   1        {
 153   2          Delay(2000); //ä¸¤ç§’ååˆ‡æ¢é¡µé¢
 154   2          Lcd_Clear();
 155   2          page = 0;//å¯†ç è¾“å®Œååˆ‡æ¢åˆ°æ ¡å‡†é¡µé¢   
 156   2        }
 157   1        
 158   1        //LCD_WriteCommand(0x80+cursor); //ç¬¬ä¸€è¡Œå…‰æ ‡
 159   1        LCD_WriteCommand(0xc0+cursor); //ç¬¬äºŒè¡Œå…‰æ ‡ 
 160   1      }
 161          
 162          //================Key=======================
 163          
 164          void Key_Proc(void)
 165          {
 166   1        if(key_slow_down) return;   //10msæ›´æ–°ä¸€æ¬¡
 167   1          key_slow_down = 1;
 168   1        
 169   1        key_value = Key_Read();
 170   1        key_down = key_value & (key_value ^ key_old);
 171   1        key_up = ~key_value & (key_value ^ key_old);
 172   1        key_old = key_value;
 173   1      
 174   1        if(key_down)       //é•¿æŒ‰äº”ç§’
 175   1          key_tick = 2000;
 176   1        
 177   1        if(key_old)
 178   1        {
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 4   

 179   2          if(key_tick == 0)
 180   2            {
 181   3              Lcd_Clear();
 182   3              page = 1;
 183   3              
 184   3              //æ¸…ç©ºå¯†ç å­—ç¬¦ä¸²
 185   3              for(password_for = 0;password_for <= 5; password_for++)
 186   3              {
 187   4                password[password_for] = '0';
 188   4              }
 189   3            }
 190   2        }
 191   1        
 192   1        if(key_tick)
 193   1        {
 194   2          switch(key_up)
 195   2          {
 196   3            case 1:        //èƒŒå…‰/æ ¡å‡†æŒ‰é”®
 197   3            {
 198   4              key_tick = 0;
 199   4              break;
 200   4            }
 201   3            case 2:        //â†‘ 
 202   3            {
 203   4              password[cursor-5] += 1;
 204   4              if(password[cursor-5] > '9')
 205   4                password[cursor-5] = '9';
 206   4            
 207   4              key_tick = 0;
 208   4              break;
 209   4            }
 210   3            case 3:        //â†“
 211   3            {
 212   4              password[cursor-5] -= 1;
 213   4              if(password[cursor-5] == '/')
 214   4                password[cursor-5] = '0';
 215   4              
 216   4              key_tick = 0;
 217   4              break;
 218   4            }
 219   3            case 4:        //â†
 220   3            {
 221   4              if(--cursor <= 5)
 222   4                cursor = 5;
 223   4              key_tick = 0;
 224   4              break;
 225   4            }
 226   3            case 5:        //â†’
 227   3            {
 228   4              if(++cursor >= 10)
 229   4                cursor = 10;
 230   4              key_tick = 0;
 231   4              break;
 232   4            }
 233   3            case 6:        //OK
 234   3            {
 235   4              if(page == 0)      //å¦‚æœåœ¨æµ‹é‡é¡µï¼ŒæŒ‰ä¸‹OKé”®å¼€å§‹æµ‹é‡
 236   4              {
 237   5                Lcd_Clear();
 238   5                page = 4;
 239   5                //K1 = 0;
 240   5              }
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 5   

 241   4              else if(page == 4) //å¦‚æœæ­£åœ¨æµ‹é‡ï¼ŒæŒ‰ä¸‹OKé”®åœæ­¢æµ‹é‡
 242   4              {
 243   5                Lcd_Clear();
 244   5                page = 0;
 245   5                
 246   5              if(cap_value_k1 < 2.20 && cap_value_k1 > 0.10)
 247   5              {
 248   6                cap_value = cap_value_k1;
 249   6                cap_units = 0;           //å•ä½æ¢æˆuF
 250   6              }
 251   5              else if(cap_value_k1 <= 0.10)
 252   5              {
 253   6                cap_value = cap_value_k2 * 100;
 254   6                cap_units = 1;           //å•ä½æ¢æˆnF
 255   6              }
 256   5              else if(cap_value_k2 <= 0.10)
 257   5              {
 258   6                cap_value = cap_value_k3 * 10;
 259   6                cap_units = 2;           //å•ä½æ¢æˆnF
 260   6              }
 261   5                
 262   5      //          if((char)cap_value_k1 != 0)//çœ‹ä¸€ä¸‹ä¸ªä½æ•°æœ‰æ²¡æœ‰å€¼
 263   5      //          {
 264   5      //            cap_value = cap_value_k1;
 265   5      //            cap_units = 0;           //å•ä½æ¢æˆuF
 266   5      //          }else if((char)cap_value_k1 == 0 && (char)cap_value_k2 != 0) //k1æµ‹ä¸åˆ°å°±æ¢k2çš„å€¼
 267   5      //          {
 268   5      //            cap_value = cap_value_k2;
 269   5      //            cap_units = 1;           //å•ä½æ¢æˆnF
 270   5      //          }else if((char)cap_value_k1 == 0 && (char)cap_value_k2 == 0 && (char)cap_value_k3 != 0) //k1æµ‹ä¸å
             -ˆ°å°±æ¢k3çš„å€¼
 271   5      //          {
 272   5      //            cap_value = cap_value_k3;
 273   5      //            cap_units = 2;           //å•ä½æ¢æˆpF
 274   5      //          }
 275   5                
 276   5                
 277   5              }
 278   4              else if(page == 1) //å¦‚æœåœ¨è¾“å¯†ç é¡µï¼ŒæŒ‰ä¸‹OKé”®ç¡®è®¤å¯†ç 
 279   4              {
 280   5                Lcd_Clear();
 281   5                if(strncmp(password,password_true,6) == 0)
 282   5                  page = 3;
 283   5                else
 284   5                  page = 2;
 285   5              }
 286   4              
 287   4              key_tick = 0;
 288   4              break;
 289   4            }
 290   3            
 291   3            default:
 292   3              break;
 293   3          }   
 294   2        }
 295   1      }
 296          
 297          //================ç”µå®¹æ£€æµ‹å‡½æ•°======================
 298          void Detection_Proc(void)
 299          {
 300   1        if(Det_slow_down) return;   //10msæ›´æ–°ä¸€æ¬¡
 301   1        Det_slow_down = 1;
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 6   

 302   1        
 303   1        if(relay_index == 1)
 304   1        {
 305   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 306   2          cap_value_k1 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 307   2        }
 308   1        else if(relay_index == 2)
 309   1        {
 310   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 311   2          cap_value_k2 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 312   2        }
 313   1        else if(relay_index == 3)
 314   1        {
 315   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 316   2          cap_value_k3 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 317   2        }
 318   1        else if(relay_index == 4)
 319   1        {
 320   2          adc_char = GetADCResult(0); //æµ‹é‡P10 ADC
 321   2          cap_value_k4 = (float)adc_char/51;//è½¬æ¢æˆç”µå‹å€¼
 322   2        }
 323   1        
 324   1      //  if(page == 4)
 325   1      //  {
 326   1      //    
 327   1      //    
 328   1      //    if((char)adc_float > 0)
 329   1      //    {
 330   1      //      cap_value = adc_float;
 331   1      //      cap_units = 0;  //unitsï¼šuF
 332   1      //    }
 333   1      //      
 334   1      //  }
 335   1      }
 336          
 337          //================ä¸­æ–­å‡½æ•°=======================
 338          void Timer0_Isr(void) interrupt 1
 339          {
 340   1        if(++key_slow_down == 10) key_slow_down = 0;
 341   1        if(++lcd_slow_down == 200) lcd_slow_down = 0;
 342   1        if(++Det_slow_down == 10) Det_slow_down = 0;
 343   1        
 344   1        if(delay_tick > 0) delay_tick--;//å»¶æ—¶å‡½æ•° ä¼šå¡ä½å½“å‰å‡½æ•°
 345   1        if(key_tick > 0) key_tick--;    //æŒ‰é”®è®¡æ—¶
 346   1        
 347   1        //å‘¼å¸ç¯ ç”¨äºæµ‹è¯•ä¸­æ–­
 348   1      //  if(++led1_tick >= 1000)
 349   1      //  {
 350   1      //    LED1 ^= 1;
 351   1      //    led1_tick = 0;
 352   1      //  }
 353   1          
 354   1        
 355   1      //  if(Buzzer == 0)
 356   1      //  {
 357   1      //    if(++buzzer_tick >= 500)
 358   1      //      {
 359   1      //        Buzzer = 1;
 360   1      //        buzzer_tick = 0;
 361   1      //      }
 362   1      //  }   
 363   1      
C51 COMPILER V9.60.0.0   MAIN                                                              11/19/2023 22:02:39 PAGE 7   

 364   1      //---------ç»§ç”µå™¨åˆ‡æ¢æ§åˆ¶----------------------
 365   1        if(page ==  4)
 366   1        {
 367   2          if(++relay_tick > 1000)
 368   2          {
 369   3            if(++relay_index > 4)
 370   3              relay_index = 1;
 371   3            relay_tick = 0;
 372   3          }
 373   2          
 374   2          Relay_Control(relay_index, 1);
 375   2        }   
 376   1          
 377   1        
 378   1      }
 379          
 380          void Delay(unsigned int delay) //å®šæ—¶å™¨å»¶æ—¶ ä¼šå¡ä½å½“å‰å‡½æ•°
 381          {
 382   1        delay_tick = delay;
 383   1        while(delay_tick > 0);
 384   1      }
 385          
 386          void Timer0_Init(void)    //1æ¯«ç§’@11.0592MHz
 387          {
 388   1        AUXR |= 0x80;     //å®šæ—¶å™¨æ—¶é’Ÿ1Tæ¨¡å¼
 389   1        TMOD &= 0xF0;     //è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
 390   1        TL0 = 0xCD;       //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 391   1        TH0 = 0xD4;       //è®¾ç½®å®šæ—¶åˆå§‹å€¼
 392   1        TF0 = 0;        //æ¸…é™¤TF0æ ‡å¿—
 393   1        TR0 = 1;        //å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 394   1        ET0 = 1;        //ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
 395   1        EA = 1;         //æ€»ä¸­æ–­
 396   1      }
 397           


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1219    ----
   CONSTANT SIZE    =     80    ----
   XDATA SIZE       =     16    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     56    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
